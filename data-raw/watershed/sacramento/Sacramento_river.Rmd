---
title: "Sacramento River"
author: "[Sadie Gill](mailto:sgill@flowwest.com), [Mark Tompkins](mailto:mtompkins@flowwest.com), [Erin Cain](mailto:ecain@flowwest.com)"
date: "June 18, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
library(tidyverse)
library(readxl)
library(cvpiaHabitat)
```

## Future Data Improvement
None Planned

## Instream Spawning and Rearing Habitat

**Data Source:**
[FWS 2003](https://www.fws.gov/lodi/instream-flow/Documents/Sacramento%20River%20Spawning%20Final%20Report%20Feb%204,%202003.pdf) (pg 29-31)

Spawning habitat area for Chinook Salmon (Fall Run, Late Fall Run, Winter Run) and Steelhead is based on data from a US Fish and Wildlife Service 2003 study of spawning habitat in the Sacramento River between Keswick Dam and the confluence with Battle Creek. Spawning habitat is only used in the Upper Sacramento River and Upper Mid-Sacramento River reaches of the life cycle model. The spawning WUA source data was developed for three study segments. One of the study segments considers conditions with and without the Anderson Cottonwood Irrigation District (ACID) diversion dam. This source data is provided on pages 29 - 31 of FWS 2003. The Upper Sacramento fall run spawning WUA values include the spawning that occurs in the Upper and Upper-mid Sacramento River (Keswick to Deer Creek). The Late-Fall Run, Winter Run, and Steelhead spawn from Keswick to Battle Creek. The A.C.I.D. boards are assumed to be in April 1st - October 31st. Mark Gard from the U.S. Fish and Wildlife Service combined the habitat data from these four studies and provided them for the entire Clear Creek watershed in a spreadsheet (see ‘~/cvpiaHabitat/data-raw/mark_gard_data/IFIMWUA.xlsx’). 

Instream rearing habitat area is based on habitat modeling conducted by NOAA NMFS for their Winter Run Chinook Salmon life cycle model. The entire mapped rearing extent of the Sacramento River was modeled using the Central Valley Floodplain Evaluation and Delineation (CVFED) HEC-RAS hydraulic model refined for use in their Winter Run Chinook Salmon life cycle model. NOAA NMFS provided tabular suitable rearing habitat area data for four reaches of the Sacramento River (Keswick to Battle Creek, Battle Creek to Feather River, and Feather River to Freeport) in the CVPIA life cycle model. The high quality depth and high quality velocity criteria ("Pref11") "ChanArea" value was used for instream habitat. High quality velocities were assumed to be less than or equal to 0.15 meters per second, and high quality depths were assumed to be between 0.2 meters and 1.5 meters. The NMFS habitat areas were scaled using the proportion of the CVPIA life cycle model reach within each NMFS study reach. The CVPIA life cycle model Upper Sacramento River reach extends from Keswick to Red Bluff (59.3 mi). This reach overlaps with two of the NMFS reaches, Keswick to Battle Creek (28.9 mi) and Battle Creek to the confluence with the Feather River (186.5 mi). The CVPIA life cycle model Upper-mid Sacramento River reach extends from Red Bluff to Wilkins Slough (122.3 mi) and is entirely within the Battle Creek to the Feather River reach of the NMFS model. The CVPIA life cycle model Lower-mid Sacramento River extends from Wilkins Slough to the American River (58.0 mi) and is represented by two of the NMFS model reaches, Battle Creek to the confluence with the Feather River (186.5 mi) and the confluence with the Feather River to Freeport (33.9 mi). Finally, the CVPIA life cycle model Lower Sacramento River reach extends from the confluence with the American River to Freeport (13.7 mi). This reach is entirely represented by the NMFS model reach that extends from the confluence with the Feather River to Freeport (33.4 mi). 


### Spawning WUA 
The instream spawning habitat weighted usable areas for Fall Run Chinook Salmon, Late Fall Run Chinook Salmon, Winter Run Chinook Salmon, and Steelhead in the Tuolumne River.Units are in square feet per 1000 feet.

```{r, echo = FALSE}
sac_spawn_in <- upper_sac_ACID_boards_in %>% 
  select(flow_cfs, FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA) %>%
  rename(FR_spawn_WUA_in = FR_spawn_WUA, LFR_spawn_WUA_in=LFR_spawn_WUA, WR_spawn_WUA_in = WR_spawn_WUA, ST_spawn_WUA_in = ST_spawn_WUA)

sac_spawn_out <- upper_sac_ACID_boards_out %>% 
  select(FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA) %>%
  rename(FR_spawn_WUA_out = FR_spawn_WUA, LFR_spawn_WUA_out=LFR_spawn_WUA, WR_spawn_WUA_out = WR_spawn_WUA, ST_spawn_WUA_out = ST_spawn_WUA)

sac_spawn <- sac_spawn_in %>% bind_cols(sac_spawn_out)

knitr::kable(align = 'c', head(sac_spawn, 5))
```

*...with 25 more rows.*

#### Fall Run Chinook Salmon Spawning WUA Plot
The following plot shows the weighted usable spawning area in square feet per thousand feet of river for Fall Run Chinook Salmon. These area per length rates are multiplied by the total spawning reach length mapped by the SIT.

``` {r,echo=FALSE}
sac_spawn_in <- upper_sac_ACID_boards_in %>% 
  select(flow_cfs, FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA)
sac_spawn_out <- upper_sac_ACID_boards_out %>% 
  select(flow_cfs, FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA) 
sac_spawn_FR_plot <- sac_spawn_in %>% 
  mutate(Type = 'FR_spawn_WUA_in') %>% 
  bind_rows(sac_spawn_out %>% mutate(Type = 'FR_spawn_WUA_out'))
ggplot(data= sac_spawn_FR_plot, aes(x = flow_cfs, y = FR_spawn_WUA, color = Type))+
  geom_line()+
  labs(x = 'flow (cfs)', y = 'WUA (sqft/1000ft)') + theme_minimal() +
  scale_color_manual(values = c('#d95f02','#7570b3'))
```

#### Late Fall Run Chinook Salmon Spawning WUA Plot
The following plot shows the weighted usable spawning area in square feet per thousand feet of river for Fall Run Chinook Salmon. These area per length rates are multiplied by the total spawning reach length mapped by the SIT.
```{r, echo=FALSE}
sac_spawn_in <- upper_sac_ACID_boards_in %>% 
  select(flow_cfs, FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA)
sac_spawn_out <- upper_sac_ACID_boards_out %>% 
  select(flow_cfs, FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA) 
sac_spawn_FR_plot <- sac_spawn_in %>% 
  mutate(Type = 'LFR_spawn_WUA_in') %>% 
  bind_rows(sac_spawn_out %>% mutate(Type = 'LFR_spawn_WUA_out'))
ggplot(data= sac_spawn_FR_plot, aes(x = flow_cfs, y = LFR_spawn_WUA, color = Type))+
  geom_line()+
  labs(x = 'flow (cfs)', y = 'WUA (sqft/1000ft)') + theme_minimal() +
  scale_color_manual(values = c('#d95f02','#7570b3'))
```

#### Winter Run Chinook Salmon Spawning WUA Plot
The following plot shows the weighted usable spawning area in square feet per thousand feet of river for Fall Run Chinook Salmon. These area per length rates are multiplied by the total spawning reach length mapped by the SIT.
```{r, echo=FALSE}
sac_spawn_in <- upper_sac_ACID_boards_in %>% 
  select(flow_cfs, FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA)

sac_spawn_out <- upper_sac_ACID_boards_out %>% 
  select(flow_cfs, FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA) 

sac_spawn_FR_plot <- sac_spawn_in %>% 
  mutate(Type = 'WR_spawn_WUA_in') %>% 
  bind_rows(sac_spawn_out %>% mutate(Type = 'WR_spawn_WUA_out'))
ggplot(data= sac_spawn_FR_plot, aes(x = flow_cfs, y = WR_spawn_WUA, color = Type))+
  geom_line()+
  labs(x = 'flow (cfs)', y = 'WUA (sqft/1000ft)') + theme_minimal() +
  scale_color_manual(values = c('#d95f02','#7570b3'))
```

#### Steelhead Spawning WUA Plot
The following plot shows the weighted usable spawning area in square feet per thousand feet of river for Steelhead. These area per length rates are multiplied by the total spawning reach length mapped by the SIT.

``` {r, echo=FALSE}
sac_spawn_in <- upper_sac_ACID_boards_in %>% 
  select(flow_cfs, FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA)

sac_spawn_out <- upper_sac_ACID_boards_out %>% 
  select(flow_cfs, FR_spawn_WUA, LFR_spawn_WUA, WR_spawn_WUA, ST_spawn_WUA) 

sac_spawn_FR_plot <- sac_spawn_in %>% 
  mutate(Type = 'ST_spawn_WUA_in') %>% 
  bind_rows(sac_spawn_out %>% mutate(Type = 'ST_spawn_WUA_out'))

ggplot(data= sac_spawn_FR_plot, aes(x = flow_cfs, y = ST_spawn_WUA, color = Type))+
  geom_line()+
  labs(x = 'flow (cfs)', y = 'WUA (sqft/1000ft)') + theme_minimal()+
  scale_color_manual(values = c('#d95f02','#7570b3'))

```

### Rearing WUA

The fry and juvenile instream rearing habitat weighted usable areas for Fall Run Chinook Salmon and Steelhead in the Tuolumne River. Units are in square feet per 1000 feet.
```{r, echo=FALSE}
upper <- upper_sacramento_river_instream %>%
  mutate(mi = 59.28, WUA_rear = rearing_sq_meters *10.76/1000) %>%
  select(flow_cfs, WUA_rear)
upper_mid <- upper_mid_sacramento_river_instream %>%
  mutate(mi = 122.25, WUA_rear = rearing_sq_meters *10.76/1000)%>%
  select( WUA_rear)
lower_mid <- lower_mid_sacramento_river_instream %>%
  mutate(mi = 57.96, WUA_rear = rearing_sq_meters *10.76/1000)%>%
  select( WUA_rear)
lower <- lower_sacramento_river_instream %>%
  mutate(mi = 13.7, WUA_rear = rearing_sq_meters *10.76/1000)%>%
  select( WUA_rear)

tot_len <- 253.19

sac <- upper %>% bind_cols(upper_mid, lower_mid, lower) %>%
  rename(FR_upper_rear_WUA = WUA_rear, FR_upper_mid_rear_WUA = WUA_rear1, FR_lower_mid_rear_WUA = WUA_rear2, FR_low_rear_WUA = WUA_rear3)%>%
  mutate(watershed = "Sacramento River")

knitr::kable(align = 'c', head(sac, 5))

```

*...with 66 more rows.*

#### Chinook Salmon Rearing WUA Plot

The following plot shows the weighted usable rearing area in square feet per thousand feet of river for Fall Run Chinook Salmon fry and juvenile. These rates are multiplied by the total rearing reach length mapped by the SIT.

```{r, echo = FALSE}
upper <- upper_sacramento_river_instream %>%
  mutate(mi = 59.28, WUA_rear = rearing_sq_meters *10.76/1000) %>%
  select(flow_cfs, WUA_rear)
upper_mid <- upper_mid_sacramento_river_instream %>%
  mutate(mi = 122.25, WUA_rear = rearing_sq_meters *10.76/1000)%>%
  select(flow_cfs, WUA_rear)
lower_mid <- lower_mid_sacramento_river_instream %>%
  mutate(mi = 57.96, WUA_rear = rearing_sq_meters *10.76/1000)%>%
  select(flow_cfs, WUA_rear)
lower <- lower_sacramento_river_instream %>%
  mutate(mi = 13.7, WUA_rear = rearing_sq_meters *10.76/1000)%>%
  select(flow_cfs, WUA_rear)

sac_plot <- upper %>% mutate(Type = 'FR_Upper_WUA') %>% 
  bind_rows(upper_mid %>% mutate(Type = 'FR_upper_mid_WUA')) %>% 
  bind_rows(lower_mid %>% mutate(Type = 'FR_lower_mid_WUA')) %>% 
  bind_rows(lower %>% mutate(Type = 'FR_lower_WUA')) 

ggplot(data= sac_plot, aes(x = flow_cfs, y = WUA_rear, color = Type))+
  geom_line()+
  labs(x = 'flow (cfs)', y = 'WUA (sqft/1000ft)') + theme_minimal()

```

## Floodplain Modeling Details
**Data Source:**
Central Valley Floodplain Evaluation and Delineation (CVFED) HEC-RAS hydraulic model refined for use in the [NOAA-NMFS Winter Run Chinook Salmon life cycle model](https://s3-us-west-2.amazonaws.com/cvpiahabitat-r-package/cvpia-sit-model-inputs/HendrixEtAl2014_Winter_Run_Model_Tech_Memo.pdf)

High quality habitat defined by:

* Channel depth > 0.2 m and < 1.5 m
* Velocity <= 0.15 m/s

The habitat areas are already suitable, don't scale down.

NOAA NMFS Winter Run Chinnok Salmon Life Cycle Model Segments:

* Section 1 - Keswick to Battle Creek (28.92 mi)
* Section 2 - Battle Creek to Feather River (186.50 mi)
* Section 3 - Feather River to Freeport (33.90 mi)

CVPIA Sacramento Rearing Segments:

* Upper Sacramento River - Keswick to Red Bluff (59.28 mi) falls within Section 1 and Section 2 of NOAA NMFS modeling
* Upper-mid Sacramento River - Red Bluff to Wilkins Slough (122.25 mi) falls within Section 2 of NOAA NMFS modeling)
* Lower-mid Sacramento River - Wilkins Slough to American (57.96 mi) falls within Section 2 and Section 3 of NOAA NMFS modeling)
* Lower Sacramento River - American to Freeport (13.70 mi) falls within Section 3 of NOAA NMFS modeling

```{r, include = FALSE}
# sac <- read_csv('data-raw/floodplain/sacramento/sacramento_floodplain.csv')

sac_floodplain <- read_csv(file = 'data-raw/floodplain/sacramento/sacramento_floodplain.csv',
                           col_names = c('flow_cfs', 'kes_bat', 'bat_feat', 'feat_free'), skip = 1) %>%
  gather(reach, sq_ft, -flow_cfs) %>%
  mutate(sq_meters = sq_ft * 0.092903)

# NOAA study reaches
kes_bat_mi <- 295.92 - 267 #keswick to battle
bat_feat_mi <- 267 - 80.5 # battle to feather
feat_free_mi <- 80.5 - 46.6 # feather to freeport

# linear interpolation functions for each study reach --------------
kes_bat <- sac_floodplain %>%
  filter(reach == 'kes_bat')

bat_feat <- sac_floodplain %>%
  filter(reach == 'bat_feat')

feat_free <- sac_floodplain %>%
  filter(reach == 'feat_free')

# look up vector for converting study reach areas into area per miles--------------
reach_miles <- c(kes_bat_mi, bat_feat_mi, feat_free_mi)
names(reach_miles) <- c('kes_bat', 'bat_feat', 'feat_free')
```

## Upper Sacramento River

The CVPIA Upper Sacramento River reach is 59.28 miles, 28.92 of those miles are in the NOAA NMFS study's first reach and the rest are in the second reach. We have summed the propotion of area by length in second reach to total in first. 

```{r, echo = FALSE}
upper_sac_above_battle <- 28.92
upper_sac_below_battle <- 59.28 - upper_sac_above_battle
prop_bat_rbdd <- upper_sac_below_battle / reach_miles['bat_feat']

upper_sac_fp <- bat_feat %>%
  mutate(sq_meter_scaled = sq_meters * prop_bat_rbdd) %>%
  bind_cols(kes_bat) %>%
  mutate(floodplain_sq_meters = sq_meter_scaled + sq_meters1,
         watershed = 'Upper Sacramento River') %>%
  select(flow_cfs, floodplain_sq_meters, watershed)

threshold <- upper_sac_fp %>%
  filter(floodplain_sq_meters == 0) %>% 
  summarise(max = max(flow_cfs)) %>% 
  pull(max)

upper_sacramento_river_floodplain <- upper_sac_fp %>% 
  filter(flow_cfs >= threshold)

knitr::kable(align = 'c', head(upper_sacramento_river_floodplain, 5))

# devtools::use_data(upper_sacramento_river_floodplain, overwrite = TRUE)
```

*... with 73 more rows*

```{r, out.width = '90%', echo = FALSE}
upper_sacramento_river_floodplain %>%
  ggplot(aes(x = flow_cfs, y = floodplain_sq_meters / 4046.86)) +
  geom_line(color = '#7570b3') +
  theme_minimal() +
  labs(x = 'Flow (cfs)', y = 'Total Suitable Acres',  title = 'Upper Sacramento River Floodplain Habitat')
```

## Upper-mid Sacramento River 

The CVPIA Upper-mid Sacramento River reach is 122.25 miles, all contained with in the NOAA NMFS study's second reach.
```{r, echo=FALSE}
rbdd_wilk_mi <- 122.25
prop_rbdd_wilkins <- rbdd_wilk_mi / reach_miles['bat_feat']

upper_mid_sac_fp <- bat_feat %>%
  mutate(floodplain_sq_meters = sq_meters * prop_rbdd_wilkins,
         watershed = 'Upper-mid Sacramento River') %>%
  select(flow_cfs, floodplain_sq_meters, watershed)

threshold <- upper_mid_sac_fp %>%
  filter(floodplain_sq_meters == 0) %>% 
  summarise(max = max(flow_cfs)) %>% 
  pull(max)

upper_mid_sacramento_river_floodplain <- upper_mid_sac_fp %>% 
  filter(flow_cfs >= threshold)

knitr::kable(align = 'c', head(upper_mid_sacramento_river_floodplain, 5))

# devtools::use_data(upper_mid_sacramento_river_floodplain, overwrite = TRUE)
```

*... with 73 more rows*

```{r, out.width = '90%', echo=FALSE}
upper_mid_sacramento_river_floodplain %>%
  ggplot(aes(x = flow_cfs, y = floodplain_sq_meters / 4046.86)) +
  geom_line(color = '#7570b3') +
  theme_minimal() +
  labs(x = 'Flow (cfs)', y = 'Total Suitable Acres',  title = 'Upper-mid Sacramento River Floodplain Habitat')
```

## Lower-mid Sacramento River 

The CVPIA Lower-mid Sacramento River reach is 57.96 miles, 33.89 of those miles are in the NOAA NMFS study's second reach and the rest are in the third reach. We have summed the propotion of area by length in second reach to total in first. 
```{r, echo=FALSE}
wilk_amer_mi <- 57.96
wilk_feather_mi <- reach_miles['bat_feat'] - rbdd_wilk_mi - upper_sac_below_battle
prop_wilkins_feather <- wilk_feather_mi / reach_miles['bat_feat']
feat_amer_mi <- wilk_amer_mi - wilk_feather_mi
prop_feat_amer <- feat_amer_mi/reach_miles['feat_free']

lower_mid_sac_fp<- bat_feat %>%
  bind_cols(feat_free) %>%
  mutate(sq_meter_scaled1 = sq_meters * prop_wilkins_feather,
         sq_meter_scaled2 = sq_meters1 * prop_feat_amer) %>%
  mutate(floodplain_sq_meters = sq_meter_scaled1 + sq_meter_scaled2,
         watershed = 'Lower-mid Sacramento River') %>%
  select(flow_cfs, floodplain_sq_meters, watershed)

threshold <- lower_mid_sac_fp %>%
  filter(floodplain_sq_meters == 0) %>% 
  summarise(max = max(flow_cfs)) %>% 
  pull(max)

lower_mid_sacramento_river_floodplain <- lower_mid_sac_fp %>% 
  filter(flow_cfs >= threshold)

knitr::kable(align = 'c', head(lower_mid_sacramento_river_floodplain, 5))
# devtools::use_data(lower_mid_sacramento_river_floodplain, overwrite = TRUE)
```

*... with 73 more rows*

```{r, out.width = '90%', echo = FALSE}
lower_mid_sacramento_river_floodplain %>%
  ggplot(aes(x = flow_cfs, y = floodplain_sq_meters / 4046.86)) +
  geom_line(color = '#7570b3') +
  theme_minimal() +
  labs(x = 'Flow (cfs)', y = 'Total Suitable Acres', title = 'Lower-mid Sacramento River Floodplain Habitat')
```

## Lower Sacramento River
The CVPIA Lower Sacramento River reach is 13.70 miles, all contained with in the NOAA NMFS study's third reach.
```{r, echo=FALSE}
amer_free_mi <- reach_miles['feat_free'] - feat_amer_mi
prop_amer_free <- amer_free_mi / reach_miles['feat_free']

lower_sac_fp <- feat_free %>%
  mutate(floodplain_sq_meters = sq_meters * prop_amer_free,
         watershed = 'Lower Sacramento River') %>%
  select(flow_cfs, floodplain_sq_meters, watershed)

threshold <- lower_sac_fp %>%
  filter(floodplain_sq_meters == 0) %>% 
  summarise(max = max(flow_cfs)) %>% 
  pull(max)

lower_sacramento_river_floodplain <- lower_sac_fp %>% 
  filter(flow_cfs >= threshold)

knitr::kable(align = 'c', head(lower_sacramento_river_floodplain, 5))
# devtools::use_data(lower_sacramento_river_floodplain, overwrite = TRUE)
```

*... with 25 more rows*

```{r, out.width = '90%', echo = FALSE}
lower_sacramento_river_floodplain %>%
  ggplot(aes(x = flow_cfs, y = floodplain_sq_meters / 4046.86)) +
  geom_line(color = '#7570b3') +
  theme_minimal() +
  labs(x = 'Flow (cfs)', y = 'Total Suitable Acres', title = 'Lower Sacramento River Floodplain Habitat')
```
